---
title: "GSE34608"
author: "Xutao Wang"
date: "10/3/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message = FALSE, cache=TRUE}
library(GEOquery)
library(preprocessCore)
library(SummarizedExperiment)
library(affy)
library(dplyr)
library(AgiMicroRna)
library(limma)
```

```{r Read in AgiMicroRna, cache = TRUE}
setwd('~/Desktop/RA work/build_TB_data/Signatures/Blankley')
getwd()
geo_access <- "GSE34608"
filePaths <- getGEOSuppFiles(geo_access)
untar(paste0(geo_access,'/',geo_access,'_RAW.tar'), exdir=paste0(geo_access,'/',geo_access,'_Raw'))
```

## Preprocessing step, no need to run again
```{r Create Target file for AgiMicroRna microRNA, include=FALSE}
# Create Target file for AgiMicroRna
## Sarcoidosis--1 for micro,  Tuberculosis--2 for micro, control -- 3 for micro 
# Platform: Agilent-019118 Human miRNA Microarray 2.0 G4470B (Feature Number version)
## A first column FileName is mandatory and includes the image data files names. A second column Treatment is also mandatory and includes the treatment effect. The third column, GErep is also mandatory, and includes the treatment effect in a numeric code
Treatment <- c(rep('Sarcoidosis_micro',8),
               rep('Tuberculosis_micro',8),
               rep('Control_micro',8))
Treatment_RNA <- c(rep('Sarcoidosis',18),
               rep('Tuberculosis',8),
               rep('Control',18))

GErep <- c(rep(1,8),
              rep(2,8),
               rep(3,8))

GErep_RNA <- c(rep(1,18),
              rep(2,8),
               rep(3,18))
target_micro <- data.frame(FileName=list.files(paste0(geo_access,'/',geo_access,'_Raw'),pattern = "txt.gz.*")[1:24],Treatment=Treatment,GErep=GErep)
write.table(target_micro,paste0(geo_access,'/',geo_access,'_Raw','/target_micro.txt'),sep='\t')

target_RNA <-  data.frame(FileName=list.files(paste0(geo_access,'/',geo_access,'_Raw'),pattern = "txt.gz.*")[25:68],Treatment=Treatment_RNA,GErep=GErep_RNA)
write.table(target_RNA,paste0(geo_access,'/',geo_access,'_Raw','/target_RNA.txt'),sep='\t')
```

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/xutaowang/Desktop/RA work/build_TB_data/Signatures/Blankley/GSE34608/GSE34608_Raw")

#knitr::opts_knit$set(root.dir = paste0(geo_access,'/',geo_access,'_Raw'))
knitr::opts_chunk$set(echo = TRUE)
```

```{r read in AgiMicroRna,cache=TRUE}
#setwd("/Users/xutaowang/Desktop/RA work/build_TB_data/Signatures/Blankley/GSE34608/GSE34608_Raw")
getwd()
target_micro <- read.delim('target_micro.txt')

GSE34608_micro <- readMicroRnaAFE(target_micro,verbose=TRUE)

# Get gTotalGeneSignal as the TotalProbeSignal times the number of probes per gene. 
# gTotalGeneSignal can be used in the differential expres- sion analysis after a possible normalization step
GSE34608_non_normalized_micro <- GSE34608_micro$TGS

# Assign rownames and colnames to the raw signal, assign Probe name to the row
row.names(GSE34608_non_normalized_micro) <- GSE34608_micro$genes$ProbeName
files <- list.files('/Users/xutaowang/Desktop/RA work/build_TB_data/Signatures/Blankley/GSE34608/GSE34608_Raw',pattern = "txt.gz.*")
files_names <- gsub('_.*','',files)
colnames(GSE34608_non_normalized_micro) <- files_names[1:24]
```

## Create Row data
```{r}
gpl7731 <- getGEO('GPL7731', GSEMatrix =  F)
gpl7331_annotate <- gpl7731@dataTable@table %>% distinct(`PROBE NAME`, .keep_all = TRUE) %>% filter(`PROBE NAME`!='')

GSE34608_micro_row_name <- row.names(GSE34608_non_normalized_micro) %>% data.frame()
names(GSE34608_micro_row_name) <- c('ProbeName')

row_data_micro <- GSE34608_micro_row_name %>%  left_join(gpl7331_annotate, by=c('ProbeName'='PROBE NAME')) %>% DataFrame()
```

## Create Column data
```{r create Column Data, cache=TRUE}
gse <- getGEO(geo_access, GSEMatrix =  F)
data_characteristic <- lapply(1:length(GSMList(gse)), function(x)  
  GSMList(gse)[[x]]@header$characteristics_ch1)
characteristic_table <- sapply(1:length(data_characteristic[[1]]), function(x) 
  sapply(data_characteristic, '[[',x)) 
characteristic_data_frame <- sub('(.*?): ','',characteristic_table) %>% DataFrame()
head(characteristic_data_frame)
colnames(characteristic_data_frame) <- c('Gender','Tissue','TBStatus','Subject')
row.names(characteristic_data_frame) <- names(GSMList(gse))
# Split MicroRNA & RNA
characteristic_data_frame_micro <- characteristic_data_frame[1:24,]
characteristic_data_frame_RNA <- characteristic_data_frame[25:68,]
head(characteristic_data_frame_micro)
```

```{r create SummarizedExperimentObject for MicroRNA, cache=TRUE}
# Create Metadata
GSE34608_experimentData_micro <- new('MIAME',
                      name="Jeroen Maertzdorf",
                      lab="MPIIB",
                      contact=" maertzdorf@mpiib-berlin.mpg.de",
                      title="Common patterns and disease-related signatures in tuberculosis and sarcoidosis.",
                      abstract="Gene and microRNA expression analysis of whole blood RNA from tuberculosis and sarcoidosis patients and healthy controls",
                      url="10.1073/pnas.1121072109",
                      pubMedIds = '22547807',
                      other=list(Platform = 'Agilent-019118 Human miRNA Microarray 2.0 G4470B (Feature Number version) GPL7731'))

GSE34608_summarizedExperiemnt_micro <- SummarizedExperiment(assays = list(GSE34608_non_normalized_micro= as.matrix(GSE34608_non_normalized_micro)), colData = characteristic_data_frame_micro, rowData = row_data_micro, metadata = list(GSE34608_experimentData_micro)); GSE34608_summarizedExperiemnt_micro

```

```{r}
saveRDS(GSE34608_summarizedExperiemnt_micro, ascii=FALSE, file='/Users/xutaowang/Desktop/RA work/build_TB_data/Signatures/Blankley/GSE34608/GSE34608_summarizedExperiemnt_micro.RDS')
```

### Make a matrix contain the NA's for the TB status cariter
#### Standard column names come from Berry GSE19443
```{r}
getwd()
geo_access <- 'GSE34608'
sobject <- readRDS(paste0(geo_access,'/',geo_access,'_summarizedExperiemnt_micro.RDS'))
```

```{r create new column information data}
standard_name_seq <- colData(readRDS('~/Desktop/RA work/build_TB_data/Signatures/Berry/GSE19443/GSE19443_summarizedExperiemnt.RDS')) %>% data.frame() %>% colnames
new_coldata <- function(sobject){
  col_info <- colData(sobject) %>% data.frame()
  dat_NA_new <- matrix(c(rep('n.a.',length(standard_name_seq)*nrow(col_info))),ncol=length(standard_name_seq),
                             byrow=T,dimnames=list(row.names(col_info),
                                                   standard_name_seq)) %>% data.frame()
  
  # fill in with existing data
  overlap_name <- standard_name_seq[which(colnames(dat_NA_new) %in% colnames(col_info))]
  for (i in overlap_name){
    dat_NA_new[i] <- col_info[i]
  }
  
  # Append the rest of cloumns to the dataframe
  col_info_rest <- col_info %>% dplyr::select(-overlap_name)
  dat_final <- cbind(dat_NA_new,col_info_rest)
  
  return(dat_final)
}

new_col_info <- new_coldata(sobject)

```

# Rename TBstatus
### PTB: active TB
### Latent
### Control
### OD: other disease
```{r}
TBStatus <- TBStatus_temp <- as.character(new_col_info$TBStatus)
unique(TBStatus_temp)
for(i in 1:length(TBStatus)){
  if(TBStatus_temp[i]=="tuberculosis"){
    TBStatus[i] = 'PTB'
  }
    if(TBStatus_temp[i]=="sarcoidosis"){
    TBStatus[i] = 'OD'
    }
      if(TBStatus_temp[i]=="control"){
    TBStatus[i] = 'Control'
  }
}
TBStatus

new_col_info$TBStatus <- TBStatus

new_col_info %>% View()

colData(sobject) <- new_col_info %>% DataFrame()

saveRDS(sobject,paste0(geo_access,'/',geo_access,'_sobject_micro.RDS'))
```











### Create Summarized Experiment Object for whole blood RNA

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/xutaowang/Desktop/RA work/build_TB_data/Signatures/Blankley/GSE34608/GSE34608_Raw")

#knitr::opts_knit$set(root.dir = paste0(geo_access,'/',geo_access,'_Raw'))
#knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Create Target file for Agi whole RNA
## Sarcoidosis--1 for micro,  Tuberculosis--2 for micro, control -- 3 for micro 
# Platform: Agilent-014850 Whole Human Genome Microarray 4x44K G4112F (Probe Name version)
#Load limma
library(limma)
targetinfo <- read.delim("target_RNA.txt")

# Reading Single-Channel Agilent Intensity Data
GSE34608_RNA <- read.maimages(targetinfo,source="agilent",green.only = TRUE)

# The green.only argument tells read.maimages() to output an EList object instead an RGList. The raw intensities will be stored in the E component of the data object
GSE34608_raw <- GSE34608_RNA$E
row.names(GSE34608_raw) <- GSE34608_RNA$genes$ProbeName
colnames(GSE34608_raw) <- files_names[25:68]
```

```{r convert ProbeID to Gene Symbol, cache=TURE}
gpl6480 <- getGEO('GPL6480',GSEMatrix = F) 
gpl6480_annotate <- gpl6480@dataTable@table

## Each ID is unique in the reference file

# Create Row Data
GSE34608_probe <- data.frame(GSE34608_RNA$genes$ProbeName)
colnames(GSE34608_probe) <- "ID_REF"
row_data <- GSE34608_probe %>% left_join(gpl6480_annotate,by=c('ID_REF'='ID')) %>% DataFrame()
```

```{r create SummarizedExperimentObject, cache=TRUE}
GSE34608_experimentData_RNA <- new('MIAME',
                      name="Jeroen Maertzdorf",
                      lab="MPIIB",
                      contact=" maertzdorf@mpiib-berlin.mpg.de",
                      title="Common patterns and disease-related signatures in tuberculosis and sarcoidosis.",
                      abstract="Gene and microRNA expression analysis of whole blood RNA from tuberculosis and sarcoidosis patients and healthy controls",
                      url="10.1073/pnas.1121072109",
                      pubMedIds = '22547807',
                      other=list(Platform = 'Agilent-019118 Human miRNA Microarray 2.0 G4470B (Feature Number version) GPL6480'))

GSE34608_summarizedExperiemnt_RNA <- SummarizedExperiment(assays = list(GSE34608_non_normalized_RNA= as.matrix(GSE34608_raw)), colData = characteristic_data_frame_RNA, rowData = row_data, metadata = list(GSE34608_experimentData_RNA)); GSE34608_summarizedExperiemnt_RNA
```

```{r}
saveRDS(GSE34608_summarizedExperiemnt_RNA, ascii=FALSE, file='/Users/xutaowang/Desktop/RA work/build_TB_data/Signatures/Blankley/GSE34608/GSE34608_summarizedExperiemnt_RNA.RDS')


# Remove files in temporary directory
unlink(paste0(normalizePath(tempdir()), "/", dir(tempdir())), recursive = TRUE)
dir(tempdir()) # check the temporary directory is empty
```

### Make a matrix contain the NA's for the TB status cariter
#### Standard column names come from Berry GSE19443
```{r}
getwd()
geo_access <- 'GSE34608'
sobject <- readRDS(paste0(geo_access,'/',geo_access,'_summarizedExperiemnt_RNA.RDS'))
```

```{r create new column information data}
standard_name_seq <- colData(readRDS('~/Desktop/RA work/build_TB_data/Signatures/Berry/GSE19443/GSE19443_summarizedExperiemnt.RDS')) %>% data.frame() %>% colnames
new_coldata <- function(sobject){
  col_info <- colData(sobject) %>% data.frame()
  dat_NA_new <- matrix(c(rep('n.a.',length(standard_name_seq)*nrow(col_info))),ncol=length(standard_name_seq),
                             byrow=T,dimnames=list(row.names(col_info),
                                                   standard_name_seq)) %>% data.frame()
  
  # fill in with existing data
  overlap_name <- standard_name_seq[which(colnames(dat_NA_new) %in% colnames(col_info))]
  for (i in overlap_name){
    dat_NA_new[i] <- col_info[i]
  }
  
  # Append the rest of cloumns to the dataframe
  col_info_rest <- col_info %>% dplyr::select(-overlap_name)
  dat_final <- cbind(dat_NA_new,col_info_rest)
  
  return(dat_final)
}

new_col_info <- new_coldata(sobject)

```

# Rename TBstatus
### PTB: active TB
### Latent
### Control
### OD: other disease
```{r}
TBStatus <- TBStatus_temp <- as.character(new_col_info$TBStatus)
unique(TBStatus_temp)
for(i in 1:length(TBStatus)){
  if(TBStatus_temp[i]=="tuberculosis"){
    TBStatus[i] = 'PTB'
  }
    if(TBStatus_temp[i]=="sarcoidosis"){
    TBStatus[i] = 'OD'
    }
      if(TBStatus_temp[i]=="control"){
    TBStatus[i] = 'Control'
  }
}
TBStatus


new_col_info$TBStatus <- TBStatus

new_col_info %>% View()

colData(sobject) <- new_col_info %>% DataFrame()

saveRDS(sobject,paste0(geo_access,'/',geo_access,'_sobject_RNA.RDS'))

```



















