---
title: "GSE50834"
author: "Xutao Wang"
date: "10/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message = FALSE}
library(GEOquery)
library(preprocessCore)
library(SummarizedExperiment)
library(limma)
library(dplyr)
library(illuminaHumanv4.db) # Illumina HumanHT-12 V4.0 expression beadchip
```

## Read in Non-normalized data
```{r, cache = TRUE}
urls <- getGEOSuppFiles('GSE50834', fetch_files = FALSE)
url_non_normalized <- as.character(urls$url[2])

temp <- tempfile()
download.file(url_non_normalized,temp)

GSE50834_Non_normalized <- read.delim(gzfile(temp),row.names = 1, header = TRUE)

dim(GSE50834_Non_normalized)
```

```{r}
# Remove .Pval
GSE50834_Non_pvalue <- GSE50834_Non_normalized[,-grep('.Pval',colnames(GSE50834_Non_normalized))] 
dim(GSE50834_Non_pvalue)
```

```{r get corresponding sample ID , cache=TRUE}
# Obtain raw data information from GEO
gse <- getGEO("GSE50834", GSEMatrix =  F)
description_id_raw <- sapply(1:length(names(GSMList(gse))), 
                             function(x) GSMList(gse)[[x]]@header$description[2])
# Demo: Convert AAA0VKQN-12_18-Mar-2009 to AAA0VKQN.12_18.Mar.2009
description_id <- sapply(1:length(description_id_raw), 
                         function(x) gsub("-", ".", description_id_raw[x]))
ID_table <- data.frame(SampleID = names(GSMList(gse)), DescriptionID = description_id)
ID_table
```

```{r mapping DescriptionID to sampleID}
# Demo: convert X6247215025_L.AVG_Signal to 6247215025_L, should use \\. when mathcing . 
indx <- sapply(1:length(ID_table$DescriptionID), 
              function(x) which(ID_table$DescriptionID %in% colnames(GSE50834_Non_pvalue)[x]))
colnames(GSE50834_Non_pvalue) <- ID_table$SampleID[indx]
GSE50834_Non_normalized_counts <- GSE50834_Non_pvalue
colnames(GSE50834_Non_normalized_counts)[1:10]
```

```{r convert ProbeID to Gene Symbol, cache=TURE}
# Annotation
PROBES <- row.names(GSE50834_Non_pvalue) # Should subsitute to Normalized file???
OUT <- AnnotationDbi::select(illuminaHumanv4.db, PROBES, "SYMBOL")
OUT[is.na(OUT)] <- 'Unmapped'

# Map ProbeID to Gene Symbol 
OUT_collapse <- OUT %>% group_by(PROBEID) %>%  # Multiple gene symbols map to the same ProbeID
  summarise(SYMBOL = paste(SYMBOL, collapse=", "), times = length(unlist(strsplit(SYMBOL, ",")))) 

GSE50834_Non_pvalue$ID_REF <- row.names(GSE50834_Non_pvalue)
GSE50834_final <- GSE50834_Non_pvalue %>% left_join(OUT_collapse, by=c('ID_REF'="PROBEID")) %>% as_tibble()

arrange(GSE50834_final, desc(times))
```

```{r}
# Create Column Data
data_characteristic <- lapply(1:length(GSMList(gse)), function(x)  
  GSMList(gse)[[x]]@header$characteristics_ch1)
characteristic_table <- sapply(1:length(data_characteristic[[1]]), function(x) 
  sapply(data_characteristic, '[[',x)) 
head(characteristic_table)
## Demo convert geographical region: Kenya to Kenya
characteristic_data_frame <- sub('(.*?): ','',characteristic_table) %>% DataFrame()
head(characteristic_data_frame)
#colnames(characteristic_data_frame) <- gsub(':.*','',data_characteristic[[1]])
colnames(characteristic_data_frame) <- c('Gender','Tissue','TBStatus')
row.names(characteristic_data_frame) <- colnames(GSE50834_Non_normalized_counts)
```

```{r create SummarizedExperiment}
# Create Row data annotation
row_data <- DataFrame(SYMBOL=GSE50834_final$SYMBOL)

# Create Metadata
GSE50834_experimentData <- new('MIAME',
                      name="Louise C Showe",
                      lab="The Wistar Institute",
                      contact="lshowe@wistar.org",
                      title="Identification of a 251 gene expression signature that can accurately detect M. tuberculosis in patients with and without HIV co-infection.",
                      abstract="Total RNA obtained from PBMC from a South African cohort. Microarry analysis was performed to compare gene expression in patients either infected with HIV or co-infected with HIV/TB.",
                      url="10.1371/journal.pone.0089925",
                      pubMedIds = '24587128',
                      other=list(Platform = 'Illumina HumanHT-12 V4.0 expression beadchip'))

GSE50834_summarizedExperiemnt <- SummarizedExperiment(assays = list(GSE50834_Non_normalized_counts= as.matrix(GSE50834_Non_normalized_counts)), colData = characteristic_data_frame, rowData = row_data, metadata = list(GSE50834_experimentData)); GSE50834_summarizedExperiemnt

```


```{r}
saveRDS(GSE50834_summarizedExperiemnt, ascii=FALSE, file='GSE50834/GSE50834_summarizedExperiemnt.RDS')

# Remove files in temporary directory
unlink(paste0(normalizePath(tempdir()), "/", dir(tempdir())), recursive = TRUE)
dir(tempdir()) # check the temporary directory is empty
```
















































