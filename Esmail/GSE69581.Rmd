---
title: "GSE69581"
author: "Xutao Wang"
date: "9/16/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import Packages
```{r libraries, message = FALSE, cache=TRUE}
library(GEOquery)
library(preprocessCore)
library(SummarizedExperiment)
library(limma)
library(dplyr)
library(illuminaHumanv4.db) # Illumina HumanHT-12 V4.0 expression beadchip
```

## Read in Non-normalized data
```{r, cache = TRUE}
#setwd('~/Desktop/RA work/build_TB_data/Signatures/Esmail')
urls = getGEOSuppFiles("GSE69581", fetch_files = FALSE)
url_non_normalized <- as.character(urls$url[1])

temp <- tempfile()
download.file(url_non_normalized,temp)

GSE69581_Non_normalized <- read.delim(gzfile(temp), row.names = 1, header = TRUE)
dim(GSE69581_Non_normalized)
```
```{r}
# Remove PValue
GSE69581_Non_normalized <- GSE69581_Non_normalized[,-grep('PValue',colnames(GSE69581_Non_normalized))]
dim(GSE69581_Non_normalized)
```

```{r boxplot for Pre-Processed normalized data, cache=TRUE}
gset <- getGEO("GSE69581", GSEMatrix =TRUE, getGPL=FALSE)
if (length(gset) > 1) idx <- grep("GPL10558", attr(gset, "names")) else idx <- 1
gset <- gset[[idx]]
dev.new(width=4+dim(gset)[[2]]/5, height=8)
par(mar=c(2+round(max(nchar(sampleNames(gset)))/2),4,2,1))
title <- paste ("GSE69581", '/', annotation(gset), " selected samples", sep ='')
boxplot(exprs(gset), boxwex=0.7, notch=T, main=title, outline=FALSE, las=2, cex.axis=0.8)
head(exprs(gset))
```

```{r}
# Set raw signal values <1 to a threshold of 1 and transform all values to log2 scale
GSE69581_log2 <- log2(replace(GSE69581_Non_normalized, GSE69581_Non_normalized < 1,1))
# For non-normalized data
boxplot(GSE69581_log2, boxwex=0.7, notch=T, main='GSE69581 non-normalized samples', outline=FALSE, las=2, cex.axis=0.8)

```

## Normalized step, try different methods (Need Discuss)
```{r normalizeBetweenArrays(), cache=TRUE}
# Method 1 
GSE69581_normalized_1 <- normalizeBetweenArrays(as.matrix(GSE69581_log2))
#dev.new(width=4+dim(GSE69581_normalized_1)[[2]]/5, height=8)
#par(mar=c(2+round(max(nchar(sampleNames(gset)))/2),4,2,1))
#title <- paste ("GSE69581", '/', annotation(gset), " selected samples", sep ='')
boxplot(GSE69581_normalized_1, boxwex=0.7, notch=T, main='GSE69581 Method 1', outline=FALSE, las=2, cex.axis=0.8)
```
```{r quantileNormalizartion()}
GSE69581_normalized_2 <- normalize.quantiles(as.matrix(GSE69581_log2))
boxplot(GSE69581_normalized_2, boxwex=0.7, notch=T, main='GSE69581 Method 2', outline=FALSE, las=2, cex.axis=0.8)

```
```{r RMA normalization??? }
# RMA based on matrix, produce a pseudo-AffyBatch Object
# intensity and intensitySD are objects equivalent to matrices.
# They should contain probe intensities in rows and samples in
# columns. Probe intensities should be ordered the same way they
# are in a .CEL file.
# chipType is a string containing the chip type (see function
# cleancdfname()).
# chipSizeX and chipSizeY specify the number of features on the chip.
# This is not Affymetrix-based microarray...

```

```{r get corresponding sample ID , cache=TRUE}
# Obtain raw data information from GEO
gse <- getGEO("GSE69581", GSEMatrix =  F)
description_id_raw <- sapply(1:length(names(GSMList(gse))), 
                             function(x) GSMList(gse)[[x]]@dataTable@columns$Column[3])
# convert PValue_9421742028_J to 9421742028_J
description_id <- sapply(1:length(description_id_raw), 
                         function(x) gsub("^(.*?)_", "", description_id_raw[x]))
ID_table <- data.frame(SampleID = names(GSMList(gse)), DescriptionID = description_id)
head(ID_table)
```

```{r mapping DescriptionID to sampleID}
# Convert X9421742043_G to 9421742043_G
colnames(GSE69581_Non_normalized) <- sapply(1:ncol(GSE69581_Non_normalized), 
                             function(x) gsub("^(.*?)X", "", colnames(GSE69581_Non_normalized)[x]))
indx <- sapply(1:length(ID_table$DescriptionID), 
              function(x) which(ID_table$DescriptionID %in% colnames(GSE69581_Non_normalized)[x]))
colnames(GSE69581_Non_normalized) <- ID_table$SampleID[indx]
GSE69581_Non_normalized_counts <- GSE69581_Non_normalized
colnames(GSE69581_Non_normalized)
```

```{r convert ProbeID to Gene Symbol, cache=TURE}
# Annotation
PROBES <- row.names(GSE69581_Non_normalized) # Should subsitute to Normalized file
OUT <- AnnotationDbi::select(illuminaHumanv4.db, PROBES, "SYMBOL")
OUT[is.na(OUT)] <- 'Unmapped'

# Map ProbeID to Gene Symbol 
OUT_collapse <- OUT %>% group_by(PROBEID) %>%  # Multiple gene symbols map to the same ProbeID
  summarise(SYMBOL = paste(SYMBOL, collapse=", "), times = length(unlist(strsplit(SYMBOL, ",")))) 

GSE69581_Non_normalized$ID_REF <- row.names(GSE69581_Non_normalized)
GSE69581_final <- GSE69581_Non_normalized %>% left_join(OUT_collapse, by=c('ID_REF' = "PROBEID")) %>% as_tibble()

#arrange(GSE69581_final, desc(times))
```

```{r create summarizedExperiment, cache=TRUE}
# Create Row data annotation
row_data <- DataFrame(SYMBOL=GSE69581_final$SYMBOL)

# Create Column data annotation
data_characteristic <- lapply(1:length(GSMList(gse)), function(x)  
  GSMList(gse)[[x]]@header$characteristics_ch1)
characteristic_table <- sapply(1:length(data_characteristic[[1]]), function(x) 
  sapply(data_characteristic, '[[',x)) 

characteristic_data_frame <- sub('(.*?): ','',characteristic_table) %>% DataFrame()
#colnames(characteristic_data_frame) <- gsub(':.*','',data_characteristic[[1]])
colnames(characteristic_data_frame) <- c('Tissue','HIVStatus','AntiRetroviralTherapy','TBStatus','Timepoint','StudyNumber')
row.names(characteristic_data_frame) <- colnames(GSE69581_Non_normalized_counts)

# Create Metadata
GSE69581_experimentData <- new('MIAME',
                      name="Hanif Esmail",
                      lab="University of Cape Town",
                      contact="hanif.esmail@ndcls.ox.ac.uk",
                      title="Complement Pathway Gene Activation and Rising Circulating Immune Complexes Characterize Early Disease in HIV-Associated Tuberculosis",
                      abstract="An example ExpressionSet",
                      url="10.1073/pnas.1711853115",
                      pubMedIds = '29339504',
                      other=list(platform = 'Illumina HumanHT-12 V4.0 expression beadchip'))

GSE69581_summarizedExperiemnt <- SummarizedExperiment(assays = list(GSE69581_Non_normalized_counts= as.matrix(GSE69581_Non_normalized_counts)), colData = characteristic_data_frame, rowData = row_data, metadata = list(GSE69581_experimentData)); GSE69581_summarizedExperiemnt

```


```{r}
#'~/Desktop/RA work/build_TB_data/Signatures/Esmail/GSE69581/'
saveRDS(GSE69581_summarizedExperiemnt, ascii=FALSE, file='~/Desktop/RA work/build_TB_data/Signatures/Esmail/GSE69581/GSE69581_summarizedExperiemnt.RDS')

# Remove files in temporary directory
unlink(paste0(normalizePath(tempdir()), "/", dir(tempdir())), recursive = TRUE)
dir(tempdir()) # check the temporary directory is empty
```

