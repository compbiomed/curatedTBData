---
title: "TBSig_test_affy"
author: "Xutao Wang"
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(MultiAssayExperiment)
library(GenomicRanges)
library(RaggedExperiment)
library(dplyr)

library(SummarizedExperiment)
library(TBSignatureProfiler)
```

# Import dataset from Affymetrix, 4 in total
```{r}
geo_set <- c('GSE54992','GSE36238','GSE31348',"GSE73408")
Affy_set_RDS <- lapply(geo_set, function(x) readRDS(paste0(x,'_sobject.RDS')))
names(Affy_set_RDS) <- geo_set

lapply(Affy_set_RDS, function(x) colData(x)$TBStatus %>% table())

GSE36238 <- Affy_set_RDS[[2]]
metadata(GSE36238)
colData(GSE54992)

GSE31348 <- Affy_set_RDS[[3]]
metadata(GSE31348)
colData(GSE31348)
```

# Create expression matrix with gene symbol. Output is a multi-assay experiment object
```{r}
get_expr_symbol <- function(sobject){
  # Read in Data
  sobject_exprs <- assay(sobject)
  row_data <- rowData(sobject) %>% data.frame()
  if(all(row.names(assay(sobject))==row_data$ID_REF)==TRUE){
    
    # Add new column to the expression matrix
    sobject_exprs_new <- sobject_exprs %>% as_tibble() %>% mutate(SYMBOL=row_data$SYMBOL_NEW) %>% filter(SYMBOL!='NA')
    
    ## Create expression matrix with gene symbol, take mean values for same genes
    sobject_exprs_symbol <- sobject_exprs_new %>% group_by(SYMBOL) %>% summarise_all(mean) %>% data.frame()
    row.names(sobject_exprs_symbol) <- sobject_exprs_symbol$SYMBOL
  
    sobject_exprs_symbol <- sobject_exprs_symbol[,-which(colnames(sobject_exprs_symbol) %in% 'SYMBOL')]
      
    ## Create MultiAssayExperiment object
    doubleExp <- list('Probe' = sobject, 'Symbol' = sobject_exprs_symbol)
    symbol_map <- data.frame(primary = row.names(colData(sobject)),
                     colname = row.names(colData(sobject)), stringsAsFactors = FALSE)
    probe_map <- data.frame(primary_info = rep("n.a.",length(row.names(colData(sobject)))),stringsAsFactors = FALSE)
    row.names(probe_map) <- row.names(colData(sobject))
  
    listmap <- list(symbol_map,symbol_map)
    names(listmap) <- c("Probe", "Symbol")
    dfmap <- listToMap(listmap)
   
    simpleMultiAssay <- MultiAssayExperiment(experiments=doubleExp,
                                          colData=probe_map,dfmap)
  
    return(simpleMultiAssay)
    
  }
  else{
     stop("all(row.names(assay(sobject))==row_data$ID_REF)==FALSE")
  }
  
}

## Create Multi-assay object for Affymetrix
Affy_set_Multi <-  lapply(Affy_set_RDS, function(x) get_expr_symbol(x))
names(Affy_set_Multi) <- geo_set
```

# Create summarized experiment object for TB signature profile
```{r}
get_sobject_TBSig <- function(multi_object){
  col_info <- multi_object[[1]] %>% colData() %>% data.frame()
  col_data <- data.frame(Sample=row.names(col_info) %>% as.factor(),Disease = col_info$TBStatus %>% as.factor())
  row.names(col_data) <- row.names(col_info)
  
  sobject_TBSig <- SummarizedExperiment(assays = list(counts= as.matrix(multi_object[[2]])), colData = col_data)
  
  # subseeting latent and PTB
  sobject_TBSig_filter <- sobject_TBSig[,sobject_TBSig$Disease %in% c("PTB","Latent")]
  
  return(sobject_TBSig_filter)
} 

Affy_set_TBSig <- lapply(Affy_set_Multi, function(x) get_sobject_TBSig(x))
# Check Disease Status
# subseeting latent and PTB

# Check the dataset that has latent information
TB_status <- lapply(Affy_set_TBSig, function(x) colData(x)$Disease)
check <- sapply(TB_status, function(x) any(levels(x) %in% c("Latent")))
names(which(check))

# Get final sobject for TB signature analysis
Affy_set_TBSig_final <- Affy_set_TBSig[names(which(check))]

# Make the disease status as character variable
for (i in 1:length(Affy_set_TBSig_final)){
  colData(Affy_set_TBSig_final[[i]])$Disease <- colData(Affy_set_TBSig_final[[i]])$Disease %>% as.character() %>% as.factor()
}

lapply(Affy_set_TBSig_final, function(x) colData(x)$Disease)
```

# START TB Signature Profile
```{r}
names(TBsignatures)

ssgsea_result_affy_list <- lapply(Affy_set_TBSig_final, 
                                  function(x) runTBsigProfiler(input = x, 
                               useAssay = "counts",
                               signatures = TBsignatures,
                               algorithm = "ssGSEA",
                               combineSigAndAlgorithm = TRUE,
                               parallel.sz = 1))
```

## Boxplot for all signatures
```{r Boxplots all, message = FALSE, results = 'hide', fig.height = 9, fig.width=15}
lapply(ssgsea_result_affy_list, 
       function(x) signatureBoxplot(inputData = x, 
                 name = "Boxplots of Signatures, ssGSEA", 
                 signatureColNames = names(TBsignatures),
                 annotationColName = "Disease", rotateLabels = FALSE,fill_colors = c("#00AFBB", "#E7B800"))
)
```

## Boxplot for Sweeney_OD_3 and the signatures where it comes from
### GSE54992
```{r,message = FALSE, results = 'hide', fig.height = 5, fig.width=15}
signatureBoxplot(inputData = ssgsea_result_affy_list[[1]], 
                 name = "Boxplots of Signatures, ssGSEA", 
                 signatureColNames = names(TBsignatures)[grep("Blankley|Sweeney_OD_3",names(TBsignatures))],
                 annotationColName = "Disease", rotateLabels = FALSE,fill_colors = c("#00AFBB", "#E7B800"))
```

### GSE73408
```{r,message = FALSE, results = 'hide', fig.height = 9, fig.width=15}
signatureBoxplot(inputData = ssgsea_result_affy_list[[2]], 
                 name = "Boxplots of Signatures, ssGSEA", 
                 signatureColNames = names(TBsignatures)[grep("Walter|Sweeney_OD_3",names(TBsignatures))],
                 annotationColName = "Disease", rotateLabels = FALSE,fill_colors = c("#00AFBB", "#E7B800"))
```

## Export plots
```{r save plots,fig.height = 8, fig.width=10}
ggsave("~/Desktop/affy_result.pdf",gridExtra::grid.arrange(signatureBoxplot(inputData = ssgsea_result_affy_list[[1]], 
                 name = "Boxplots of Signatures, ssGSEA", 
                 signatureColNames = names(TBsignatures)[grep("Blankley|Sweeney_OD_3",names(TBsignatures))],
                 annotationColName = "Disease", rotateLabels = FALSE,fill_colors = c("#00AFBB", "#E7B800")), signatureBoxplot(inputData = ssgsea_result_affy_list[[2]], 
                 name = "Boxplots of Signatures, ssGSEA", 
                 signatureColNames = names(TBsignatures)[grep("Walter|Sweeney_OD_3",names(TBsignatures))],
                 annotationColName = "Disease", rotateLabels = FALSE,fill_colors = c("#00AFBB", "#E7B800"))))
```

# Get AUC for all the signatures
```{r AUC table, message = FALSE}
# Some problems with bootstrap, when the sample size is small, we could sample data with the same outcome,
# cannot calculate AUC in such cases
get_pvalue_auc <- function(SE_scored, annotationColName, signatureColNames){
  pvals <- aucs <- aucs_boot <- NULL
  annotationData <- SummarizedExperiment::colData(SE_scored)[annotationColName][,1]
  for (i in signatureColNames) {
    score <- SummarizedExperiment::colData(SE_scored)[i][, 
                                                         1]
    pvals <- c(pvals, stats::t.test(score ~ annotationData)$p.value)
    pred <- ROCit::rocit(score, annotationData)
    auc <- pred$AUC
    aucs <- c(aucs, max(auc, 1 - auc))
  }
  return(data.frame(Signature=signatureColNames,P.value=pvals,AUC=aucs))
  
}
auc_pval_result_affy <- lapply(ssgsea_result_affy_list, function(x)
  get_pvalue_auc(x, 
         annotationColName = "Disease", 
         signatureColNames = names(TBsignatures))
  )
```

# Rideoplots for AUC
```{r,fig.height = 15, fig.width=8}
library(ggplot2)
library(ggridges)
dat1 <- do.call(rbind,auc_pval_result_affy)
dat2 <- do.call(rbind,auc_pval_result_hiseq)
dat3 <- do.call(rbind,auc_pval_result_other)
dat4 <- do.call(rbind,auc_pval_result_illumina)

dat <- rbind(dat1,dat2,dat3,dat4)
ggplot(dat,aes(x=AUC,y=Signature)) + geom_density_ridges()
```

```{r, fig.height = 5, fig.width=10}
dat_new <- dat %>% filter(Signature %in% c("Sweeney_OD_3","Blankley_5","Anderson_42","Anderson_OD_51","Berry_393","Berry_OD_86","Singhania_OD_20"))

ggplot(dat_new,aes(x=AUC,y=Signature)) + geom_density_ridges()
```





