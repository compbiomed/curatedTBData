---
title: "curatedTBData - Progression"
author: "Xutao Wang"
output:
  BiocStyle::html_document:
    toc_float: true
  BiocStyle::pdf_document: default
package: BiocStyle
vignette: >
  %\VignetteIndexEntry{curatedTBData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache.lazy = FALSE, message=FALSE, warning=FALSE)
```

```{r libraries, message=FALSE}
library(BiocParallel)
library(dplyr)
library(dtplyr)
library(edgeR)
library(GEOquery)
library(ggplot2)
library(ggridges)
library(gridExtra)
library(limma)
library(MultiAssayExperiment)
library(plyr)
library(SummarizedExperiment)
library(sva)
library(TBSignatureProfiler)

devtools::load_all()
library(curatedTBData)
```

```{r load a list of datasets, eval=FALSE}
# To get a summary table for all the studies:
# data("DataSummary",package="curatedTBData")

# Load single data
# get_curatedTBData("GSE39939")

# Load Multiple Studies
# get_curatedTBData(c("GSE39939","GSE107993"))

# Get a list of all data
objects_list <- get_curatedTBData(geo_access="All")

```

# Normalization
```{r normalized/matched sample, cache=TRUE, results="hide", eval=FALSE}
#Initialize parallel
param <- SerialParam(progressbar=TRUE)
# Normalization. For RNA-seq data, we use raw data from online for normalization (Not the self-processed data)
# Use online raw data by specifying the experiment_type=assay_raw
object_norm <- bplapply(objects_list, function(x) Normalization(x, experiment_type = "assay_raw"),BPPARAM = param) 

# Match Probe to gene symbols
# Use the normalized data from assay_raw by specifying the experiment_type=assay_raw_norm
object_match1 <- bplapply(object_norm, function(x) MatchProbe(x, experiment_type = "assay_raw_norm"),BPPARAM = param)

# Remove samples with TBStatus == NA
object_match <- bplapply(object_match1, function(x) x[,colData(x)[,"TBStatus"]!= "NA"],BPPARAM = param)

# Define the list of TB signatures
TBsignatures <- TBSignatureProfiler::TBsignatures
```

```{r, results="hide",include=FALSE}
#Initialize parallel
param <- SerialParam(progressbar=TRUE)

object_match1 <- readRDS("~/Desktop/object_match1.RDS")
# Remove samples with TBStatus == NA
object_match <- bplapply(object_match1, function(x) x[,colData(x)[,"TBStatus"]!= "NA"],BPPARAM = param)

# Define the list of TB signatures
TBsignatures <- TBSignatureProfiler::TBsignatures
```

# Signature for predicting progression

Datasets GSE79362 (Adolescent Cohort Study/ACS), GSE94438 (GC6-74), GSE107994, GSE112104 contain information about latent progression. Next, we consider using gene signatures to predict progression information. GSE107993 only includes latent non-progressor and control samples.

## ssGSEA{.tabset}

### Calculation

```{r Calculate ssGSEA for progression, cache=TRUE, results = "hide"}
gse_progress <- c("GSE79362", "GSE107994", "GSE94438","GSE112104")
multi_set_progress <- lapply(object_match[gse_progress], function(x)
  SubsetTBStatus(x, annotationColName = "Progression", c("Positive","Negative"), experiment_type = "assay_reduce")) %>% plyr::compact()

ssgsea_progress <- lapply(multi_set_progress,
                    function(x) TBSignatureProfiler::runTBsigProfiler(input = x,
                                  useAssay = assayNames(x),
                                  signatures = TBsignatures, 
                                  algorithm = "ssGSEA",
                                  combineSigAndAlgorithm = TRUE,
                                  parallel.sz = 14))

# Obtain p.value, AUC
ssgsea_progress_combine <- combine_auc(ssgsea_progress, annotationColName = "Progression", signatureColNames = names(TBsignatures), num.boot=50)

# Obtain signature gene rank
#sig_list_progression <- bplapply(ssgsea_progress, function(x) get_gsea_rank(x, TBsignatures, annotationColName = "Progression"),BPPARAM=param)
#TBsignatures_sub_progress <- TBsignatures[lapply(TBsignatures, function(x) length(x)<=29) %>% unlist]

#get_rank_boxplot(sig_list_progression,gset="Sweeney_OD_3")
```

### Boxplot for progression{.tabset}

```{r Boxplot for progression, results = "asis", fig.width=8, fig.height = 10, fig.wide=TRUE}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  BoxplotTBSig(ssgsea_progress, gset = i, annotationColName = "Progression")
  
  cat("\n\n")
}
```

### Boxplot for progression gene rank{.tabset}
```{r Boxplot for each signature rank progression, results = "asis", fig.width=30, fig.height = 20, fig.wide=TRUE, eval=FALSE}
for (i in names(TBsignatures_sub_progress)){

  cat("####", i, "\n")
  
  get_rank_boxplot(sig_list_progression,i)
  
  cat("\n\n")
}
```


```{r include = FALSE}
# Need this chunk to ensure the inclusion/embedding of DT required javascript to work 
DT::datatable(NULL)
```

### Table for progression{.tabset}

```{r Table for progression, results = "asis"}
for (i in gse_progress){

  cat("####", i, "\n")
  
  print(htmltools::tagList(DT::datatable(ssgsea_progress_combine %>% dplyr::filter(GSE == i) %>% dplyr::select(-GSE))))

  cat("\n\n")
}
```

### Summary table
Compute mean AUC and bootstrapped 95% CI
```{r summary table Progression}
# Seletct signatures and associated AUC
PTB_progress_auc_summary <- ssgsea_progress_combine %>% dplyr::select(Signature, AUC) %>% dplyr::group_split(Signature)

# Get summarized table and bootstrap 95% Confidence Interval
ssgsea_progress_auc_CI <- cbind(Signature=sapply(PTB_progress_auc_summary, function(x) x$Signature[1]),
      do.call(rbind,lapply(PTB_progress_auc_summary, function(x){
  bootstrap_mean_CI(x, colName="AUC", percent=0.95, num.boot=100)
}
)) ) 

ssgsea_progress_auc_CI %>% DT::datatable()

```

### Heatmap{.tabset}

#### Without Grouping

```{r progression heatmap without grouping, fig.width=6, fig.height = 10}
GSE_sig <- readxl::read_excel("~/Desktop/RA work/build_TB_data/Signatures/Signature_data_cur.xlsx",sheet = "Sheet2")

heatmap_auc(ssgsea_progress_combine, GSE_sig, names(TBsignatures), facet = FALSE) + xlab("Datasets") + theme(axis.title.x = element_text(angle=45,vjust=1.3,hjust=-0.2,size=12,face="bold")) + ggtitle("Heatmap of AUC for predicting TB progression")
```

#### With Group

```{r progression heatmap with grouping, fig.width=6, fig.height = 10}
heatmap_auc(ssgsea_progress_combine, GSE_sig, names(TBsignatures), facet = TRUE) + ggtitle("Heatmap of AUC for predicting TB progression") + xlab("Datasets") + theme(axis.title.x = element_text(angle=45,vjust=1.3,hjust=-0.2,size=12,face="bold")) + xlab("Datasets")

```

## Singscore{.tabset}

### Calculate Singscore

```{r singscore progression, results = "hide"}
# Define Singscore function
singscore_sobject <- function(sobject,TB_sig){
  param <- SerialParam(progressbar=TRUE)
  sobject_new <- sobject
  rowData(sobject_new) <- NULL
  dat <- na.omit(assay(sobject))
  
  rankData <- singscore::rankGenes(dat)
  score_list <- bplapply(TB_sig, function(i) suppressWarnings(singscore::simpleScore(rankData, upSet = i, knownDirection = FALSE)$TotalScore), BPPARAM=param)
  score_df <- do.call(cbind,score_list)
  colData(sobject_new) <- DataFrame(colData(sobject_new),score_df)
  
  return(sobject_new)
}

singscore_progress <- lapply(multi_set_progress, function(x)
  singscore_sobject(x,TBsignatures))

# Obtain p.value/ AUC
singscore_progress_combine <- combine_auc(singscore_progress, annotationColName = "Progression", signatureColNames = names(TBsignatures), num.boot = 50, percent = 0.95)

```

### Boxplot for singscore{.tabset}

```{r, results = "asis", message = FALSE, fig.width=30, fig.height = 32, fig.wide=TRUE}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  BoxplotTBSig(singscore_progress, gset = i, annotationColName = "TBStatus")
  
  cat("\n\n")
}
```

```{r include = FALSE}
# Need this chunk to ensure the inclusion/embedding of DT required javascript to work 
DT::datatable(NULL)
```

### Table with T-tests & AUC{.tabset}

```{r Table for each signature Progression Singscore, cache=TRUE, results = "asis"}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  print(htmltools::tagList(DT::datatable(singscore_progress_combine %>% dplyr::filter(Signature == i) %>% dplyr::select(-Signature))))
  
  cat("\n\n")
}
```

### Summary Table for AUC and its Confidence Interval

```{r summary table Progression Singscore}
# Seletct signatures and associated AUC
progress_auc_summary_singscore <- singscore_progress_combine %>% dplyr::select(Signature, AUC) %>% dplyr::group_split(Signature)

# Get summarized table and bootstrap 95% Confidence Interval
singscore_progress_auc_CI <- cbind(Signature=sapply(progress_auc_summary_singscore, function(x) x$Signature[1]),
      do.call(rbind,lapply(progress_auc_summary_singscore, function(x){
  bootstrap_mean_CI(x, colName="AUC", percent=0.95, num.boot=100)
}
)) ) 

singscore_progress_auc_CI %>% DT::datatable()

```

### Comparison of Signature Performance using AUCs{.tabset}

#### Ridge Plot{.tabset}

##### Single Ridge Plot

```{r, fig.width=8, fig.height = 15, cache=TRUE}
get_auc_distribution(singscore_progress_combine) + ggtitle("Ridge plot of AUC for PTB vs. OD (Singscore)") + ggplot2::theme(axis.text.x = ggplot2::element_text(colour="Black", size=12, hjust = 0.5, face="bold"),
                 axis.text.y = ggplot2::element_text(size=12, angle = 0, hjust = 0.5))

```

##### ssGSEA as reference

```{r, fig.width=8, fig.height = 15, cache=TRUE}
myColors <- RColorBrewer::brewer.pal(3,"Set1")
d1 <- ssgsea_progress_combine
d1$type <- "ssGSEA" 
d2 <- singscore_progress_combine
d2$type <- "Singscore" 

d3 <- rbind(d1,d2)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(2,1)]) 

```

##### Singscore as reference

```{r, fig.width=8, fig.height = 15, cache=TRUE}

d1 <- ssgsea_progress_combine
d1$type <- "ssGSEA" 
d2 <- singscore_progress_combine
d2$type <- "Singscore" 

# change the level of sigantrures by switching the order of rbind
d3_B <- rbind(d2,d1)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3_B,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(2,1)]) 

```

#### Heatmap
```{r progression heatmap singscore, fig.width=10, fig.height = 15, fig.wide=TRUE}
# Import signature and data information
heatmap_auc(singscore_progress_combine, GSE_sig, names(TBsignatures), facet = TRUE) + ggtitle("Heatmap of AUC for progression (Singscore)")
```

## PLAGE{.tabset}

### Calculate PLAGE

```{r calculate PLAGE for progression, results="hide"}
# genes with constant expression across samples will be NaN after standardization.
plage_progress <- lapply(multi_set_progress,
                    function(x) TBSignatureProfiler::runTBsigProfiler(input = x,
                                  useAssay = assayNames(x),
                                  signatures = TBsignatures, 
                                  algorithm = "PLAGE",
                                  combineSigAndAlgorithm = TRUE,
                                  parallel.sz = 14))

plage_progress_combine <- combine_auc(plage_progress, annotationColName = "Progression", signatureColNames = names(TBsignatures), num.boot = 60, percent = 0.95)
```

### Boxplot for singscore{.tabset}

```{r, results = "asis", message = FALSE, fig.width=30, fig.height = 32, fig.wide=TRUE}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  BoxplotTBSig(plage_progress, gset = i, annotationColName = "TBStatus")
  
  cat("\n\n")
}
```

### Summary Table for AUC and its Confidence Interval

```{r summary table progression PLAGE}
# Seletct signatures and associated AUC
progress_auc_summary_plage <- plage_progress_combine %>% dplyr::select(Signature, AUC) %>% dplyr::group_split(Signature)

# Get summarized table and bootstrap 95% Confidence Interval
plage_progress_auc_CI <- cbind(Signature=sapply(progress_auc_summary_plage, function(x) x$Signature[1]),
      do.call(rbind,lapply(progress_auc_summary_plage, function(x){
  bootstrap_mean_CI(x, colName="AUC", percent=0.95, num.boot=100)
}
)) ) 

plage_progress_auc_CI %>% DT::datatable()

```

### Comparison of Signature Performance using AUCs{.tabset}

#### Ridge Plot{.tabset}

##### Single Ridge Plot

```{r, fig.width=8, fig.height = 15}
# Ridge plot for AUCs distribution across datasets
get_auc_distribution(plage_progress_combine) + ggtitle("Ridge plot of AUC for progression (plage)") + ggplot2::theme(axis.text.x = ggplot2::element_text(colour="Black", size=12, hjust = 0.5, face="bold"),
                 axis.text.y = ggplot2::element_text(size=12, angle = 0, hjust = 0.5))

```

##### ssGSEA as reference

```{r, fig.width=8, fig.height = 15, cache=TRUE}
myColors <- RColorBrewer::brewer.pal(3,"Set1")

d1 <- ssgsea_progress_combine
d1$type <- "ssGSEA" 
d2 <- plage_progress_combine
d2$type <- "PLAGE" 

d_singscore <- singscore_progress_combine
d_singscore$type <- "Singscore"
d3 <- rbind(d1,d2)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(3,1)]) 

```

##### PLAGE as reference

```{r, fig.width=8, fig.height = 15, cache=TRUE}
d3_B <- rbind(d2,d1)

ggplot(d3_B,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(3,1)]) 

```

##### ssGSEA as reference for all three methods

```{r, fig.width=8, fig.height = 15}
d_all <- rbind(d1,d2,d_singscore)

ggplot(d_all,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(3,2,1)]) 

```


#### Heatmap
```{r progression heatmap plage, fig.width=10, fig.height = 15, fig.wide=TRUE}
# Import signature and data information
heatmap_auc(plage_progress_combine, GSE_sig, names(TBsignatures), facet = TRUE) + ggtitle("Heatmap of AUC for progression (PLAGE)")
```

```{r,eval=FALSE,include=FALSE}
combine_auc_CI <- function(auc_CI_data,method){
  
  data <-  auc_CI_data[,-1]
  data_new <-  sapply(1:ncol(data), function(x) formatC( round( data[,x], 3 ), format='f', digits=3 ))
  result = data.frame(auc_CI_data[,1],paste0(data_new[,1]," (",data_new[,2],",",data_new[,3],")"))
  colnames(result) = c("Signature",method)
  return(result)
}
ssgsea1 = ssgsea_progress_auc_CI %>% dplyr::arrange(desc(`Mean AUC`))

singscore1 = singscore_progress_auc_CI
plage1 = plage_progress_auc_CI

final = combine_auc_CI(ssgsea1,"ssGSEA") %>% left_join(combine_auc_CI(singscore1,"Singscore"),by = c("Signature" = "Signature")) %>% left_join(combine_auc_CI(plage1,"PLAGE"),by = c("Signature" = "Signature"))
final$bet="&"

data.frame(final$Signature,final$bet,final$ssGSEA,final$bet, final$Singscore,final$bet,final$PLAGE) %>% View()
a = strsplit(final$Signature,"_")
paste0(a[[1]],collapse = "*\_")
```


# Session Information

```{r session information}
sessionInfo()
```

