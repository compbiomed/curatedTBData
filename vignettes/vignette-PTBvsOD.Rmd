---
title: "curatedTBData - PTB vs OD"
author: "Xutao Wang"
output:
  BiocStyle::html_document:
    toc_float: true
  BiocStyle::pdf_document: default
package: BiocStyle
vignette: >
  %\VignetteIndexEntry{curatedTBData}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache.lazy = FALSE, message=FALSE, warning=FALSE)
```

```{r libraries, message=FALSE}
library(BiocParallel)
library(dplyr)
library(dtplyr)
library(edgeR)
library(GEOquery)
library(ggplot2)
library(ggridges)
library(gridExtra)
library(limma)
library(MultiAssayExperiment)
library(plyr)
library(SummarizedExperiment)
library(sva)
library(TBSignatureProfiler)

devtools::load_all()
library(curatedTBData)
```

```{r load a list of datasets,eval=FALSE}
# To get a single data, run the following:
# data(package="curatedTBData")
# data(GSE39939_sobject)

list_files <- data(package="curatedTBData")[["results"]][,"Item"]

# Get a list of all data
data(list=list_files) # Takes some time...
strobject <- ls(pattern="*object$")

# Create a list for loaded data for metadata analysis
objects_list <- lapply(strobject, function(x) get(x)) # Takes some time...
objects_name <- gsub("_.*","",strobject)
names(objects_list) <- objects_name

```

# Normalization

```{r normalized/matched sample, cache=TRUE, results="hide",eval=FALSE}
#Initialize parallel
param <- SerialParam(progressbar=TRUE)
# Normalization. For RNA-seq data, we use raw data from online for normalization (Not the self-processed data)
# Use online raw data by specifying the experiment_type=assay_raw
object_norm <- bplapply(objects_list, function(x) Normalization(x, experiment_type = "assay_raw"),BPPARAM = param) 

# Match Probe to gene symbols
# Use the normalized data from assay_raw by specifying the experiment_type=assay_raw_norm
object_match1 <- bplapply(object_norm, function(x) MatchProbe(x, experiment_type = "assay_raw_norm"),BPPARAM = param)

# Remove samples with TBStatus == NA
object_match <- bplapply(object_match1, function(x) x[,colData(x)[,"TBStatus"]!= "NA"],BPPARAM = param)

# Define the list of TB signatures
TBsignatures <- TBSignatureProfiler::TBsignatures
```

```{r, results="hide",include=FALSE}
#Initialize parallel
param <- SerialParam(progressbar=TRUE)

object_match1 <- readRDS("~/Desktop/object_match1.RDS")
# Remove samples with TBStatus == NA
object_match <- bplapply(object_match1, function(x) x[,colData(x)[,"TBStatus"]!= "NA"],BPPARAM = param)

# Define the list of TB signatures
TBsignatures <- TBSignatureProfiler::TBsignatures
```

# Active TB (PTB) vs. Other Diseases (OD)

## ssGSEA

### Calculate ssGSEA

```{r calculate ssgsea for PTB vs OD, cache=TRUE, results = "hide"}
# Select sample contain information about PTB and Other Diseases (OD)
# Modify the list to make it compatible with TBSignatureProfiler

multi_set_PTB_OD <- lapply(object_match, function(x)
  SubsetTBStatus(x, annotationColName = "TBStatus",diseases = c("PTB","OD"), experiment_type = "assay_reduce")) %>% plyr::compact()   # Remove empty objects use plyr::compact()

ssgsea_PTB_OD <- lapply(multi_set_PTB_OD,
                    function(x) TBSignatureProfiler::runTBsigProfiler(input = x,
                                  useAssay = assayNames(x),
                                  signatures = TBsignatures, 
                                  algorithm = "ssGSEA",
                                  combineSigAndAlgorithm = TRUE,
                                  parallel.sz = 14))


# Obtain p.value, AUC
ssgsea_PTB_OD_combine <- combine_auc(ssgsea_PTB_OD, annotationColName = "TBStatus", signatureColNames = names(TBsignatures), num.boot=50)

```

### Boxplots signature scores{.tabset}

```{r Boxplot for each signature PTB vs. OD, cache=TRUE, results = "asis", fig.width=28, fig.height = 30, fig.wide=TRUE}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  BoxplotTBSig(ssgsea_PTB_OD, gset = i, annotationColName = "TBStatus")
  
  cat("\n\n")
}
```

```{r include = FALSE}
# Need this chunk to ensure the inclusion/embedding of DT required javascript to work 
DT::datatable(NULL)
```

### Table with T-tests & AUC{.tabset}

```{r Table for each signature PTB vs. OD, cache=TRUE, results = "asis"}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  print(htmltools::tagList(DT::datatable(ssgsea_PTB_OD_combine %>% dplyr::filter(Signature == i) %>% dplyr::select(-Signature))))
  
  cat("\n\n")
}
```

### Summary Table for AUC and its Confidence Interval

Compute mean AUC and bootstrapped 95% CI
```{r suumary table PTB vs. OD}
# Seletct signatures and associated AUC
PTB_OD_auc_summary <- ssgsea_PTB_OD_combine %>% dplyr::select(Signature, AUC) %>% dplyr::group_split(Signature)

# Get summarized table and bootstrap 95% Confidence Interval
cbind(Signature=sapply(PTB_OD_auc_summary, function(x) x$Signature[1]),
      do.call(rbind,lapply(PTB_OD_auc_summary, function(x){
  bootstrap_mean_CI(x, colName="AUC", percent=0.95, num.boot=100)
}
)) ) %>% DT::datatable()

```

### Comparison of Signature Performance using AUCs{.tabset}

#### Ridge Plot{.tabset}

##### Single Ridge Plot

```{r AUC ridge plot for PTB vs OD, fig.width=8, fig.height = 15, cache=TRUE}
# Ridge plot for AUCs distribution across datasets
# PTB vs. OD
get_auc_distribution(ssgsea_PTB_OD_combine) + ggtitle("Ridge plot of AUC for PTB vs. OD") + ggplot2::theme(axis.text.x = ggplot2::element_text(colour="Black", size=12, hjust = 0.5, face="bold"),
                 axis.text.y = ggplot2::element_text(size=12, angle = 0, hjust = 0.5))

```

##### PTB vs OD as reference

```{r AUC ridge plot for PTB vs OD and PTB vs OD, fig.width=8, fig.height = 15, cache=TRUE,eval=FALSE,include=FALSE}
d1 <- ssgsea_PTB_OD_combine
d1$type <- "PTBvsOD" 
d2 <- ssgsea_PTB_OD_combine
d2$type <- "PTBvsOD" 

d3 <- rbind(d1,d2)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = c("blue","red")) + ggtitle("PTB vs OD as reference")

```

##### PTB vs OD as reference
```{r AUC ridge plot for PTB vs OD and PTB vs OD2, fig.width=8, fig.height = 15, cache=TRUE, eval=FALSE, include=FALSE}
d3_1 <- rbind(d2,d1)

ggplot(d3_1,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Comparison", values = c("blue","red")) + ggtitle("PTB vs OD as reference")

```



#### Heatmap{.tabset}

##### Without grouping

```{r PTB vs. OD heatmap without grouping, fig.width=8, fig.height = 12, fig.wide=TRUE}
# Import signature and data information
GSE_sig <- readxl::read_excel("~/Desktop/RA work/build_TB_data/Signatures/Signature_data_cur.xlsx",sheet = "Sheet2")

heatmap_auc(ssgsea_PTB_OD_combine, GSE_sig, names(TBsignatures), facet = FALSE) + ggtitle("Heatmap of AUC for PTB vs. OD")
```

##### With grouping
```{r PTB vs. OD heatmap with grouping, fig.width=8, fig.height = 12, fig.wide=TRUE}
heatmap_auc(ssgsea_PTB_OD_combine, GSE_sig, names(TBsignatures), facet = TRUE) + ggtitle("Heatmap of AUC for PTB vs. OD")

# Use if want to add axis label
# + xlab("Datasets") + theme(axis.title.x = element_text(angle=45,vjust=0.5,hjust=-0.12,size=13,face="bold"))
```


## Singscore{.tabset}

### Calculate Singscore

```{r singscore PTB vs OD, results = "hide"}
singscore_sobject <- function(sobject,TB_sig){
  param <- SerialParam(progressbar=TRUE)
  sobject_new <- sobject
  rowData(sobject_new) <- NULL
  dat <- na.omit(assay(sobject))
  
  rankData <- singscore::rankGenes(dat)
  score_list <- bplapply(TB_sig, function(i) suppressWarnings(singscore::simpleScore(rankData, upSet = i, knownDirection = FALSE)$TotalScore), BPPARAM=param)
  score_df <- do.call(cbind,score_list)
  colData(sobject_new) <- DataFrame(colData(sobject_new),score_df)
  
  return(sobject_new)
}

singscore_PTB_OD <- lapply(multi_set_PTB_OD, function(x)
  singscore_sobject(x,TBsignatures))

# Obtain p.value/ AUC
singscore_PTB_OD_combine <- combine_auc(singscore_PTB_OD, annotationColName = "TBStatus", signatureColNames = names(TBsignatures), num.boot = 50, percent = 0.95)

```

### Boxplot for singscore{.tabset}

```{r, results = "asis", message = FALSE, fig.width=30, fig.height = 32, fig.wide=TRUE}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  BoxplotTBSig(singscore_PTB_OD, gset = i, annotationColName = "TBStatus")
  
  cat("\n\n")
}
```

```{r include = FALSE}
# Need this chunk to ensure the inclusion/embedding of DT required javascript to work 
DT::datatable(NULL)
```

### Table with T-tests & AUC{.tabset}

```{r Table for each signature PTB vs. OD Singscore, cache=TRUE, results = "asis"}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  print(htmltools::tagList(DT::datatable(singscore_PTB_OD_combine %>% dplyr::filter(Signature == i) %>% dplyr::select(-Signature))))
  
  cat("\n\n")
}
```

### Summary Table for AUC and its Confidence Interval

```{r suumary table PTB vs. OD Singscore}
# Seletct signatures and associated AUC
PTB_OD_auc_summary_singscore <- singscore_PTB_OD_combine %>% dplyr::select(Signature, AUC) %>% dplyr::group_split(Signature)

# Get summarized table and bootstrap 95% Confidence Interval
cbind(Signature=sapply(PTB_OD_auc_summary_singscore, function(x) x$Signature[1]),
      do.call(rbind,lapply(PTB_OD_auc_summary_singscore, function(x){
  bootstrap_mean_CI(x, colName="AUC", percent=0.95, num.boot=100)
}
)) ) %>% DT::datatable()

```

### Comparison of Signature Performance using AUCs{.tabset}

#### Ridge Plot{.tabset}

##### Single Ridge Plot

```{r, fig.width=8, fig.height = 15, cache=TRUE}
# Ridge plot for AUCs distribution across datasets
# PTB vs. OD
get_auc_distribution(singscore_PTB_OD_combine) + ggtitle("Ridge plot of AUC for PTB vs. OD (Singscore)") + ggplot2::theme(axis.text.x = ggplot2::element_text(colour="Black", size=12, hjust = 0.5, face="bold"),
                 axis.text.y = ggplot2::element_text(size=12, angle = 0, hjust = 0.5))

```

##### ssGSEA as reference

```{r AUC ridge plot for Singscore vs ssGSEA A, fig.width=8, fig.height = 15, cache=TRUE}
# blue: Singscore
# red: ssGSEA
myColors <- RColorBrewer::brewer.pal(3,"Set1")
d1 <- ssgsea_PTB_OD_combine
d1$type <- "ssGSEA" 
d2 <- singscore_PTB_OD_combine
d2$type <- "Singscore" 

d3 <- rbind(d1,d2)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(2,1)]) 

```

##### Singscore as reference

```{r AUC ridge plot for Singscore vs ssGSEA B, fig.width=8, fig.height = 15, cache=TRUE}
# blue: Singscore
# red: ssGSEA
d1 <- ssgsea_PTB_OD_combine
d1$type <- "ssGSEA" 
d2 <- singscore_PTB_OD_combine
d2$type <- "Singscore" 

# change the level of sigantrures by switching the order of rbind
d3_B <- rbind(d2,d1)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3_B,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(2,1)]) 

```

#### Heatmap
```{r PTB vs. OD heatmap singscore, fig.width=10, fig.height = 15, fig.wide=TRUE}
# Import signature and data information
heatmap_auc(singscore_PTB_OD_combine, GSE_sig, names(TBsignatures), facet = TRUE) + ggtitle("Heatmap of AUC for PTB vs. OD (Singscore)")
```

## PLAGE{.tabset}

### Calculate PLAGE

```{r calculate PLAGE for PTB vs OD, results="hide"}
# genes with constant expression across samples will be NaN after standardization.
plage_PTB_OD <- lapply(multi_set_PTB_OD,
                    function(x) TBSignatureProfiler::runTBsigProfiler(input = x,
                                  useAssay = assayNames(x),
                                  signatures = TBsignatures, 
                                  algorithm = "PLAGE",
                                  combineSigAndAlgorithm = TRUE,
                                  parallel.sz = 14))

plage_PTB_OD_combine <- combine_auc(plage_PTB_OD, annotationColName = "TBStatus", signatureColNames = names(TBsignatures), num.boot = 60, percent = 0.95)
```

### Boxplot for singscore{.tabset}

```{r, results = "asis", message = FALSE, fig.width=30, fig.height = 32, fig.wide=TRUE}
for (i in names(TBsignatures)){

  cat("####", i, "\n")
  
  BoxplotTBSig(plage_PTB_OD, gset = i, annotationColName = "TBStatus")
  
  cat("\n\n")
}
```

### Summary Table for AUC and its Confidence Interval

```{r suumary table PTB vs. OD PLAGE}
# Seletct signatures and associated AUC
PTB_OD_auc_summary_plage <- plage_PTB_OD_combine %>% dplyr::select(Signature, AUC) %>% dplyr::group_split(Signature)

# Get summarized table and bootstrap 95% Confidence Interval
cbind(Signature=sapply(PTB_OD_auc_summary_plage, function(x) x$Signature[1]),
      do.call(rbind,lapply(PTB_OD_auc_summary_plage, function(x){
  bootstrap_mean_CI(x, colName="AUC", percent=0.95, num.boot=100)
}
)) ) %>% DT::datatable()

```

### Comparison of Signature Performance using AUCs{.tabset}

#### Ridge Plot{.tabset}

##### Single Ridge Plot

```{r, fig.width=8, fig.height = 15}
# Ridge plot for AUCs distribution across datasets
get_auc_distribution(plage_PTB_OD_combine) + ggtitle("Ridge plot of AUC for PTB vs. OD (plage)") + ggplot2::theme(axis.text.x = ggplot2::element_text(colour="Black", size=12, hjust = 0.5, face="bold"),
                 axis.text.y = ggplot2::element_text(size=12, angle = 0, hjust = 0.5))

```

##### ssGSEA as reference

```{r AUC ridge plot for PLAGE vs ssGSEA (A), fig.width=8, fig.height = 15, cache=TRUE}
myColors <- RColorBrewer::brewer.pal(3,"Set1")

d1 <- ssgsea_PTB_OD_combine
d1$type <- "ssGSEA" 
d2 <- plage_PTB_OD_combine
d2$type <- "PLAGE" 

d_singscore <- singscore_PTB_OD_combine
d_singscore$type <- "Singscore"
d3 <- rbind(d1,d2)
# add 50% AUC line
aucs_result_dat_lines <- data.frame(Signature = d1$Signature,x0=0.5)

ggplot(d3,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(3,1)]) 

```

##### PLAGE as reference

```{r AUC ridge plot for PLAGE vs ssGSEA (B), fig.width=8, fig.height = 15, cache=TRUE}
d3_B <- rbind(d2,d1)

ggplot(d3_B,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(3,1)]) 

```

##### ssGSEA as reference for all three methods

```{r, fig.width=8, fig.height = 15}
d_all <- rbind(d1,d2,d_singscore)

ggplot(d_all,aes(x=AUC,y=Signature,color=type)) + geom_density_ridges(jittered_points=TRUE,alpha=0.7,quantile_lines = TRUE, quantiles = 2) + geom_segment(data = aucs_result_dat_lines, aes(x = x0, xend = x0, y = as.numeric(Signature),
                                                   yend = as.numeric(Signature) + .9), color = "black") + theme_bw() + scale_color_manual(name = "Method", values = myColors[c(3,2,1)]) 

```


#### Heatmap
```{r PTB vs. OD heatmap plage, fig.width=10, fig.height = 15, fig.wide=TRUE}
# Import signature and data information
heatmap_auc(plage_PTB_OD_combine, GSE_sig, names(TBsignatures), facet = TRUE) + ggtitle("Heatmap of AUC for PTB vs. OD (PLAGE)")
```





# Session Information

```{r session info}
sessionInfo()

