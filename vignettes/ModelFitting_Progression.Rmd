---
title: "Model Fitting for Progression"
author: "Xutao Wang"
date: "6/23/2020"
output:
  BiocStyle::html_document:
    code_folding: "hide"
    toc_float: true
  BiocStyle::pdf_document: default
package: BiocStyle
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, cache.lazy = FALSE, message=FALSE, warning=FALSE)
```

# Load required library

```{r libraries, message=FALSE}
library(BiocParallel)
library(dplyr)
library(edgeR)
library(GEOquery)
library(ggplot2)
library(ggridges)
library(gridExtra)
library(limma)
library(MultiAssayExperiment)
library(SummarizedExperiment)
library(caret)

devtools::load_all()
library(curatedTBData)
```

# Load Studies
Datasets GSE79362 (Adolescent Cohort Study/ACS), GSE94438 (GC6-74), GSE107994, GSE112104 contain information about latent progression.

```{r, results="hide"}
gse_progress <- c("GSE79362", "GSE107994","GSE94438","GSE112104")
progress_raw <- get_curatedTBData(gse_progress)

param <- SerialParam(progressbar=TRUE)
progress_norm <- bplapply(progress_raw, function(x) 
  Normalization(x, RNAseq_method = "TMM", experiment_name = "assay_reprocess"), BPPARAM = param) 



# Subset samples with progression information
progress_norm_filter <- lapply(progress_norm, function(x) subset_curatedTBData(x, annotationColName = "Progression", annotationCondition = c("Positive","Negative"), experiment_name = "assay_reprocess_norm")) %>% plyr::compact()

# Define the list of TB signatures

TBsignatures <- TBSignatureProfiler::TBsignatures
TB_RISK_signatures <- TBsignatures[c("Leong_RISK_29","Suliman_RISK_4",
                                     "Zak_RISK_16", "Sweeney_OD_3")]
```

# Method 1

Go to the original study and check how they get the gene signatures

## Leong_RISK_29

Use GSE79362 as traning dataset, GSE94438 and GSE112104 as testing datasets
```{r, warning=FALSE, results="hide"}
train_ACS <- function(theObject_train, theObject_test,signatureName, annotationColName, 
                      annotationCase, method, GSE_test){
  signatureGenes <- TBsignatures[[signatureName]]

  dat_train <- assay(theObject_train)
  dat_train_sig <- dat_train %>% data.frame() %>% 
    dplyr::filter(row.names(dat_train) %in% signatureGenes) %>% 
                       t() %>% data.frame()
  progress_status_train <- SummarizedExperiment::colData(theObject_train)[,annotationColName]
  
  # Convert to numeric binary results
  dat_train_sig <- data.frame(dat_train_sig, 
                              Status = ifelse(progress_status_train == annotationCase, 1, 0))
  
  dat_test <- assay(theObject_test)
  dat_test_sig <- dat_test %>% data.frame() %>% 
    dplyr::filter(row.names(dat_test) %in% signatureGenes) %>% 
                       t() %>% data.frame()
  progress_status_test <- SummarizedExperiment::colData(theObject_test)[,annotationColName]
  
  # Convert to numeric binary results
  dat_test_sig <- data.frame(dat_test_sig, 
                              Status = ifelse(progress_status_test == annotationCase, 1, 0))
  
  
  cv_10 <- caret::trainControl(method = "cv", number = 10)
  model_train <- caret::train(Status ~ ., data = dat_train_sig, method = method,
                                    trControl = cv_10, preProcess = c("center","scale"))

  predict_result <- stats::predict(model_train, newdata = dat_test_sig)
  
  # Calcualte AUC
  auc_result <-  ROCit::rocit(predict_result,dat_test_sig$Status)
  result <- data.frame(Signature = signatureName, 
                       AUC = max(auc_result$AUC,1-auc_result$AUC),
                       GSE = GSE_test, Method = method)
  return(result)
  
}


theObject_train <- progress_norm_filter$GSE79362

signatureName <- "Leong_RISK_29"
method <- c("glmnet","ranger", "svmLinear", "xgbLinear")

annotationColName <- "Progression"
annotationCase <- "Positive"

GSE112104_result <- lapply(method, function(x) {
  theObject_test <- progress_norm_filter$GSE112104
  GSE_test <- "GSE112104"
  
  train_ACS(theObject_train, theObject_test, signatureName, annotationColName, 
            annotationCase, x, GSE_test)
  })

GSE94438_result <- lapply(method, function(x) {
  
  theObject_test <- progress_norm_filter$GSE94438
  GSE_test <- "GSE94438"
  
  train_ACS(theObject_train, theObject_test, signatureName, annotationColName, 
            annotationCase, x, GSE_test)
  })

GSE107994_result <- lapply(method, function(x) {
  
  theObject_test <- progress_norm_filter$GSE107994
  GSE_test <- "GSE107994"
  
  train_ACS(theObject_train, theObject_test, signatureName, annotationColName, 
            annotationCase, x, GSE_test)
  })

do.call(rbind,GSE107994_result)
```

```{r}
method1_Leong <- rbind(do.call(rbind,GSE112104_result),
                 do.call(rbind,GSE94438_result),
                 do.call(rbind,GSE107994_result))
method1_Leong
```

```{r}
ggplot(method1_Leong, aes(x=GSE, y=AUC)) + 
  geom_point(aes(colour = Method)) + theme_bw()
```


# Method 2
Look at the paper, for each of the signarure, construct a classification model.
follow their procedures. 
Suliman\_RISK\_4 and Zak\_RISK\_16 were evaluated using support vector machines (SVM)
Sweeney\_OD\_3 uses difference of geometric mean to calculate prediction score.

## SVM

```{r}
train_SVM <- function(theObject_train, theObject_test,signatureName, annotationColName,
                                       annotationCase, GSE_test){
  
  signatureGenes <- TBSignatureProfiler::TBsignatures[[signatureName]]
  
  ## Process traning data
  # Obtain original expression matrix
  dat_train <- SummarizedExperiment::assay(theObject_train) %>% data.frame()
  progress_status_train <- SummarizedExperiment::colData(theObject_train)[,annotationColName]
  
  # Convert to numeric binary results
  status_number_train <- ifelse(progress_status_train == annotationCase, 1, 0)
  # Subset data with only genes belong to gene signature
  dat_sub_train <- dat_train %>% dplyr::filter(row.names(dat_train) %in% signatureGenes) %>% 
                       t() %>% data.frame()
  
  ## Process testing data
  dat_test <- SummarizedExperiment::assay(theObject_test) %>% data.frame()
  progress_status_test <- SummarizedExperiment::colData(theObject_test)[,annotationColName]
  
  # Convert to numeric binary results
  status_number_test <- ifelse(progress_status_test == annotationCase, 1, 0)
  # Subset data with only genes belong to gene signature
  dat_sub_test <- dat_test %>% dplyr::filter(row.names(dat_test) %in% signatureGenes) %>% 
                       t() %>% data.frame()
  
  if(signatureName == "Suliman_RISK_4"){
    # Calculate paired ratio if signature is Suliman_RISK_4
    dat_suliman_train <- dat_sub_train %>% dplyr::mutate(GAS6_CD1C=GAS6/CD1C,
                                             SEPT4_BLK=SEPT4/BLK,
                                             SEPT4_CD1C=SEPT4/CD1C,
                                             GAS6_BLK=GAS6/BLK) %>% 
                   dplyr::select(GAS6_CD1C,SEPT4_BLK,SEPT4_CD1C,GAS6_BLK)
    
    dat_sig_train <- data.frame(dat_suliman_train, Status = status_number_train)
    
    if(ncol(dat_sub_train) == ncol(dat_sub_test)){
      
      svm_model <- e1071::svm(Status ~ ., data = dat_sig_train, type = "nu-regression", 
                     kernel = "linear", cost = 100, cachesize = 5000, tolerance = 0.01,
                     shrinking = FALSE, cross = 3)
      dat_suliman_test <- dat_sub_test %>% dplyr::mutate(GAS6_CD1C=GAS6/CD1C,
                                             SEPT4_BLK=SEPT4/BLK,
                                             SEPT4_CD1C=SEPT4/CD1C,
                                             GAS6_BLK=GAS6/BLK) %>% 
                   dplyr::select(GAS6_CD1C,SEPT4_BLK,SEPT4_CD1C,GAS6_BLK)
    
       dat_sig_test <- data.frame(dat_suliman_test, Status = status_number_test)
    
       predict_result <- predict(svm_model,dat_sig_test)
       auc_result <-  ROCit::rocit(predict_result,dat_sig_test$Status)
       result <- data.frame(Signature=signatureName, 
                            AUC=max(auc_result$AUC,1-auc_result$AUC),
                            GSE=GSE_test)
       return(result)
      
    }else{
      
      dat_suliman_train <- dat_sub_train %>% dplyr::mutate(GAS6_CD1C=GAS6/CD1C,
                                             GAS6_BLK=GAS6/BLK) %>% 
                                             dplyr::select(GAS6_CD1C,GAS6_BLK)
      dat_sig_train <- data.frame(dat_suliman_train, Status = status_number_train)
      svm_model <- e1071::svm(Status ~ ., data = dat_sig_train, type = "nu-regression", 
                     kernel = "linear", cost = 100, cachesize = 5000, tolerance = 0.01,
                     shrinking = FALSE, cross = 3)
      dat_suliman_test <- dat_sub_test %>% dplyr::mutate(GAS6_CD1C=GAS6/CD1C,
                                             GAS6_BLK=GAS6/BLK) %>% 
                                             dplyr::select(GAS6_CD1C,GAS6_BLK)
    
       dat_sig_test <- data.frame(dat_suliman_test, Status = status_number_test)
    
       predict_result <- predict(svm_model,dat_sig_test)
       auc_result <-  ROCit::rocit(predict_result,dat_sig_test$Status)
       result <- data.frame(Signature=signatureName, 
                            AUC=max(auc_result$AUC,1-auc_result$AUC),
                            GSE=GSE_test)
       return(result)
      
    }
  
  }
  
  else{
    
    dat_sig_train <- data.frame(dat_sub_train, Status = status_number_train)
    svm_model <- e1071::svm(Status ~ ., data = dat_sig_train, type = "nu-regression", 
                     kernel = "linear", cost = 100, cachesize = 5000, tolerance = 0.01,
                     shrinking = FALSE, cross = 3)
    dat_sig_test <- data.frame(dat_sub_test, Status = status_number_test)
    
    predict_result <- predict(svm_model,dat_sig_test)
    auc_result <-  ROCit::rocit(predict_result,dat_sig_test$Status)

    result <- data.frame(Signature=signatureName, 
                       AUC=max(auc_result$AUC,1-auc_result$AUC),
                       GSE=GSE_test)
    return(result)

  }
}

```

### ZAK_RISK_16

```{r}
zak_svm_result <- lapply(seq_len(length(progress_norm_filter)), function(x){
  theObject_train <- progress_norm_filter$GSE79362
  theObject_test <- progress_norm_filter[[x]]
  signatureName <- "Zak_RISK_16"
  annotationColName <- "Progression"
  annotationCase <- "Positive"
  GSE_test <- names(progress_norm_filter)[x]
  
  train_SVM(theObject_train, theObject_test,signatureName, annotationColName,
                                       annotationCase, GSE_test)
} )


do.call(rbind,zak_svm_result)
```

### Suliman_RISK_4

```{r}
suliman_svm_result <- lapply(seq_len(length(progress_norm_filter)), function(x){
  theObject_train <- progress_norm_filter$GSE94438
  theObject_test <- progress_norm_filter[[x]]
  signatureName <- "Suliman_RISK_4"
  annotationColName <- "Progression"
  annotationCase <- "Positive"
  GSE_test <- names(progress_norm_filter)[x]
  
  train_SVM(theObject_train, theObject_test,signatureName, annotationColName,
                                       annotationCase, GSE_test)
} )

do.call(rbind,suliman_svm_result)
```


## Difference of Geometric Means

### Sweeney_OD_3{.tabset}

Apply `DESeq2` for differential analysis

#### Progression

```{r, include=FALSE, eval=FALSE}
library("DESeq2")

train_DEseq2_GeometricMean <- function(theObject_raw, theObject_matched, signatureName, annotationColName, GSE, DataType){
  
  if(DataType == "RNA_seq"){
    ddsSE <- DESeq2::DESeqDataSet(theObject_raw, design = as.formula(paste0("~", annotationColName)))
  S4Vectors::mcols(ddsSE) <- NULL
  dds <- DESeq2::DESeq(ddsSE)
  
  res <- results(dds)
  res <- res[complete.cases(res),]
  res$ID_REF <- row.names(res)
  row_data <- dplyr::as_tibble(SummarizedExperiment::rowData(theObject_raw))
  res_with_symbol <- res %>% as_tibble() %>% inner_join(row_data,
                                           by = c("ID_REF" = "ID_REF"))
  
  res_with_symbol <- res_with_symbol[order(res_with_symbol$padj),]
  
  # Identify genes that are up/down-regulated

  upR <- res_with_symbol[(res_with_symbol$padj < 0.05) & (res_with_symbol$log2FoldChange > 0),]
  upR_signature <- upR %>% filter(SYMBOL_NEW %in% TBSignatureProfiler::TBsignatures[[signatureName]]) %>% dplyr::select(SYMBOL_NEW) %>% unique()
  
  downR <- res_with_symbol[(res_with_symbol$padj < 0.05) & (res_with_symbol$log2FoldChange < 0),]
  downR_signature <- downR %>% filter(SYMBOL_NEW %in% TBSignatureProfiler::TBsignatures[[signatureName]]) %>% dplyr::select(SYMBOL_NEW) %>% unique()
  }
  if(DataType == "Microaarray"){
    # Do something else
    }
  
  if(nrow(upR_signature) != 0){
    dat <- SummarizedExperiment::assay(theObject_matched) %>% data.frame()
    
    dat_sig <- dat %>% dplyr::filter(row.names(dat) %in% unlist(upR_signature,use.names = FALSE)) %>% t() %>% data.frame()
    up_sample_score <- apply(dat_sig, 1, function(x) exp(mean(log(x))))
  }
  else{
    up_sample_score <- rep(0,ncol(theObject_matched))
    names(up_sample_score) <- colnames((theObject_matched))
  }
  
  if(nrow(downR_signature) != 0){
    dat <- SummarizedExperiment::assay(theObject_matched) %>% data.frame()
    
    dat_sig <- dat %>% dplyr::filter(row.names(dat) %in% unlist(downR_signature,use.names = FALSE)) %>% t() %>% data.frame()
    down_sample_score <- apply(dat_sig, 1, function(x) exp(mean(log(x))))
  }
  else{
    down_sample_score <- rep(0,ncol(theObject_matched))
    names(down_sample_score) <- colnames((theObject_matched))
  }
  
  # Obtain sample prediction score (Difference of geometric mean)
  sample_score <- up_sample_score - down_sample_score
  auc_result <-  ROCit::rocit(sample_score,SummarizedExperiment::colData(theObject_matched)
                                                    [,annotationColName])

  result <- data.frame(Signature=signatureName, 
                       AUC=max(auc_result$AUC,1-auc_result$AUC),
                       GSE=GSE)
  return(result)
  
}
```

```{r}
train_sweeney_GeometricMean <- function(theObject_matched, annotationColName, GSE,signatureName){
  up_set <- c("GBP5","DUSP3 ")
  dn_set <- "KLF2"
  dat <- SummarizedExperiment::assay(theObject_matched) %>% data.frame()
    
  dat_sig_up <- dat %>% dplyr::filter(row.names(dat) %in% unlist(up_set,use.names = FALSE)) %>% t() %>% data.frame()
  up_sample_score <- apply(dat_sig_up, 1, function(x) exp(mean(log(x))))
  
  dat_sig_dn<- dat %>% dplyr::filter(row.names(dat) %in% unlist(dn_set,use.names = FALSE)) %>% t() %>% data.frame()
  down_sample_score <- apply(dat_sig_dn, 1, function(x) exp(mean(log(x))))
  
  sample_score <- up_sample_score - down_sample_score
  auc_result <-  ROCit::rocit(sample_score,SummarizedExperiment::colData(theObject_matched)
                                                    [,annotationColName])

  result <- data.frame(Signature=signatureName, 
                       AUC=max(auc_result$AUC,1-auc_result$AUC),
                       GSE=GSE)
  return(result)
}

sweeney_GM_result <- lapply(seq_len(length(progress_norm_filter)), function(x){

  theObject_matched <- progress_norm_filter[[x]]
  annotationColName <- "Progression"
  GSE <- names(progress_norm_filter)[x]
  signatureName <- "Sweeney_OD_3"
  train_sweeney_GeometricMean(theObject_matched,annotationColName,GSE,signatureName)

})

do.call(rbind,sweeney_GM_result)
```

#### PTB vs. Latent
```{r, include=FALSE, eval=FALSE}
# Check for other datasets as suggseted in the paper
gse_sweeney <- c("GSE42825","GSE42826","GSE42827","GSE42830","GSE42831","GSE42832","GSE37250",
                 "GSE19435", "GSE19439", "GSE19442", "GSE19443", "GSE19444", "GSE22098")

object_sweeney <- get_curatedTBData(gse_sweeney,include.reprocess = FALSE)


# PTB vs. Latent
object_sweeney_PTB_Latent_matched <- lapply(object_match[gse_sweeney], function(x)
  subset_curatedTBData(x, annotationColName = "TBStatus", annotationCondition = c("PTB","Latent"), experiment_name = "assay_MatchProbe")) %>% plyr::compact()

sweeney_GM_result_PTB_Latent <- lapply(seq_len(length(object_sweeney_PTB_Latent_matched)), function(x){

  theObject_matched <- object_sweeney_PTB_Latent_matched[[x]]
  annotationColName <- "TBStatus"
  GSE <- names(object_sweeney_PTB_Latent_matched)[x]
  
  train_sweeney_GeometricMean(theObject_matched,annotationColName,GSE)

})

do.call(rbind,sweeney_GM_result_PTB_Latent)
```

#### PTB vs. OD
```{r, include=FALSE, eval=FALSE}
# PTB vs. OD
object_sweeney_PTB_OD_matched <- lapply(object_match[gse_sweeney], function(x)
  subset_curatedTBData(x, annotationColName = "TBStatus", annotationCondition = c("PTB","OD"), experiment_name = "assay_MatchProbe")) %>% plyr::compact()

sweeney_GM_result_PTB_OD <- lapply(seq_len(length(object_sweeney_PTB_OD_matched)), function(x){

  theObject_matched <- object_sweeney_PTB_OD_matched[[x]]
  GSE <- names(object_sweeney_PTB_OD_matched)[x]
  annotationColName <- "TBStatus"
  
  train_sweeney_GeometricMean(theObject_matched,annotationColName,GSE)

})

do.call(rbind,sweeney_GM_result_PTB_OD)
```

#### PTB vs. HCs
```{r, include=FALSE, eval=FALSE}
# PTB vs. Control
object_sweeney_PTB_HC_matched <- lapply(object_match[gse_sweeney], function(x)
  subset_curatedTBData(x, annotationColName = "TBStatus", annotationCondition = c("PTB","Control"), experiment_name = "assay_MatchProbe")) %>% plyr::compact()

sweeney_GM_result_PTB_HC <- lapply(seq_len(length(object_sweeney_PTB_HC_matched)), function(x){
 
  theObject_matched <- object_sweeney_PTB_HC_matched[[x]]
  GSE <- names(object_sweeney_PTB_HC_matched)[x]
  annotationColName <- "TBStatus"

  train_sweeney_GeometricMean(theObject_matched,annotationColName,GSE)
  
})

do.call(rbind,sweeney_GM_result_PTB_HC)
```

## Summary Plot

```{r}
method2 <- rbind(data.frame(do.call(rbind,zak_svm_result), Method="SVM"),
                 data.frame(do.call(rbind,suliman_svm_result), Method="SVM"),
                 data.frame(do.call(rbind,sweeney_GM_result), Method="GeometricMean"))

# ggplot(method2, aes(x=.data$Signature, y=.data$AUC, fill=Method)) + 
#    geom_boxplot() + theme_bw()

heatmap_auc(method2, SignatureInfo, 
            names(TBsignatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using Random Forest")

```


# Method 3{.tabset}

Split each data into half traning and half testing. For each signature, apply classfication methods: Elastic Net, Random Foreset, SVM on the traning data to train the model. Evaluate the performance of each signatures in the testing part of the data. Also include Mass-o-meno, ssGSEA, PLAGE as gene set enrichemnt method for comparison. 

## Elastic Net

```{r, results="hide"}
train_each_signature <- function(dat_full,signatureGenes, status_number, method){
    
                # Subset data with only genes belong to gene signature
                dat_sub <- dat_full %>% 
                       dplyr::filter(row.names(dat_full) %in% signatureGenes) %>% 
                       t() %>% data.frame()
             
                dat <- data.frame(dat_sub, Status = status_number)
  
               # Split the data into traning and testing
                set.seed(123)
                dat_idx <- caret::createDataPartition(dat$Status, p = 0.5, list = FALSE)
                dat_trn <- dat[dat_idx, ]
                dat_tst <-  dat[-dat_idx,]
                
                if(method == "Mas-o-menos"){
                  
                  dat_sub_scale <- apply(dat_sub, 2, scale)
                  
                  # In case there exist NaN, remove them
                  dat_sub_scale <- dat_sub_scale[,which(colSums(is.nan(dat_sub_scale))==0)]
                  gene_feature_name <- colnames(dat_sub_scale)
                  dat_scale <- data.frame(dat_sub_scale, Status = status_number)
                  v <- lapply(gene_feature_name, function(x){
                               glm.fit <- glm(Status ~ dat_scale[,x] -1, 
                                              data = dat_scale, family = binomial)
                               ifelse(glm.fit$coefficients>0, 1, -1)
                           
                         } )
                  v_new <- unlist(v, use.names = FALSE)/sqrt(length(v))
                  predict_result <- vapply(seq_len(nrow(dat_sub_scale)),function(x,v){
                    t(dat_sub_scale[x,])%*%v },numeric(1), v=v_new)
                  
                  # Calcualte AUC
                  auc_result <-  ROCit::rocit(predict_result,dat_scale$Status)
                  auc_result$AUC
                }
                
                else{
                # Set up 5-fold cross validation
                cv_5 <-  caret::trainControl(method = "cv", number = 5)
                def_result <- caret::train(Status ~ ., data = dat_trn, method = method,
                                    trControl = cv_5, preProcess = c("center","scale"))
                predict_result <- stats::predict(def_result, newdata = dat_tst)
  
                # Calcualte AUC
                auc_result <-  ROCit::rocit(predict_result,dat_tst$Status)
                auc_result$AUC
    }
}

train_curatedTBData <- function(theObject, signatureGenes_list, annotationColName,
                                           annotationCase, GSE, method){
  
  # Obtain original expression matrix
  dat_full <- SummarizedExperiment::assay(theObject) %>% data.frame()
  progress_status <- SummarizedExperiment::colData(theObject)[,annotationColName]
  
  # Convert to numeric binary results
  status_number <- ifelse(progress_status == annotationCase, 1, 0)
  
  param <- BiocParallel::SerialParam(progressbar=TRUE)
  signature_auc <- BiocParallel::bplapply(signatureGenes_list, function(y){
              train_each_signature(dat_full,y,status_number,method)
  }, BPPARAM = param)
  
  result <- data.frame(Signature=names(signature_auc), 
                       AUC=unlist(signature_auc,use.names=F),
                       GSE=GSE)
  return(result)
}


progress_EN <- lapply(seq_len(length(progress_norm_filter)), 
                      function(x,signatureGenes_list, annotationColName, annotationCase){
  method <- "glmnet"
  theObject <- progress_norm_filter[[x]]
  GSE <- names(progress_norm_filter)[x]
  
  train_curatedTBData(theObject, signatureGenes_list, annotationColName,
                                 annotationCase, GSE, method)
  
},TB_RISK_signatures,annotationColName = "Progression", annotationCase = "Positive")

heatmap_auc(do.call(rbind,progress_EN), SignatureInfo, 
            names(TBsignatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using Elastic Net")
```

## Random Forest

```{r, results="hide"}
progress_rf <- lapply(seq_len(length(progress_norm_filter)), 
                      function(x,signatureGenes_list, annotationColName, annotationCase){
  method <- "ranger"
  theObject <- progress_norm_filter[[x]]
  GSE <- names(progress_norm_filter)[x]
  
  train_curatedTBData(theObject, signatureGenes_list, annotationColName,
                                 annotationCase, GSE, method)
  
},TB_RISK_signatures,annotationColName = "Progression", annotationCase = "Positive")

heatmap_auc(do.call(rbind,progress_rf), SignatureInfo, 
            names(TBsignatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using Random Forest")
```

## SVM

```{r, results="hide"}
progress_svm <- lapply(seq_len(length(progress_norm_filter)), 
                      function(x,signatureGenes_list, annotationColName, annotationCase){
  method <- "svmLinear"
  theObject <- progress_norm_filter[[x]]
  GSE <- names(progress_norm_filter)[x]
  
  train_curatedTBData(theObject, signatureGenes_list, annotationColName,
                                 annotationCase, GSE, method)
  
},TB_RISK_signatures,annotationColName = "Progression", annotationCase = "Positive")

heatmap_auc(do.call(rbind,progress_svm), SignatureInfo, 
            names(TBsignatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using SVM")
```

## Mas-o-menos
Let each component $X_{ij}$ of the $p\times 1$ covariate vector $\mathbf{X_i}=(X_{i1},\dots,X_{ip})^T$ be a quantitative measurement of the $j^{th}$ gene from the $i^{th}$ subject. A simple sign averaging method. Standardized the covariates, perform univariate regressions of the outcome on each covariate (gene) to obtain marginal estimates of the regression coefficient $\hat{\alpha}_j$. \
Let $\hat{v}_j=sgn(\hat{\alpha}_j)/\sqrt{p}$, the risk score for the $i^{th}$ patient is $\mathbf{X^T_i\hat{v}}$.

```{r, results="hide"}
progress_mom <- lapply(seq_len(length(progress_norm_filter)), 
                      function(x,signatureGenes_list, annotationColName, annotationCase){
  method <- "Mas-o-menos"
  theObject <- progress_norm_filter[[x]]
  GSE <- names(progress_norm_filter)[x]
  
  train_curatedTBData(theObject, signatureGenes_list, annotationColName,
                                 annotationCase, GSE, method)
  
},TB_RISK_signatures,annotationColName = "Progression", annotationCase = "Positive")

heatmap_auc(do.call(rbind,progress_mom), SignatureInfo, 
            names(TB_RISK_signatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using Mas-o-menos")
```

## ssGSEA

```{r, results="hide"}
ssgsea_progress <- lapply(progress_norm_filter,
                    function(x) TBSignatureProfiler::runTBsigProfiler(input = x,
                                  useAssay = assayNames(x),
                                  signatures = TB_RISK_signatures, 
                                  algorithm = "ssGSEA",
                                  combineSigAndAlgorithm = TRUE))
# Obtain p.value, AUC
ssgsea_progress_combine <- combine_auc(ssgsea_progress, annotationColName = "Progression", 
                                       signatureColNames = names(TB_RISK_signatures), num.boot=NULL) %>% 
  dplyr::select(-P.value) %>% dplyr::mutate(Method="ssGSEA")

heatmap_auc(ssgsea_progress_combine, SignatureInfo, 
            names(TB_RISK_signatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using ssGSEA")

```

## PLAGE
```{r, results="hide"}
plage_progress <- lapply(progress_norm_filter,
                    function(x) TBSignatureProfiler::runTBsigProfiler(input = x,
                                  useAssay = assayNames(x),
                                  signatures = TB_RISK_signatures, 
                                  algorithm = "PLAGE",
                                  combineSigAndAlgorithm = TRUE))

# Obtain p.value, AUC
plage_progress_combine <- combine_auc(plage_progress, annotationColName = "Progression", signatureColNames = names(TB_RISK_signatures), num.boot=NULL) %>% 
  dplyr::select(-P.value) %>% dplyr::mutate(Method = "PLAGE")

heatmap_auc(plage_progress_combine, SignatureInfo, 
            names(TB_RISK_signatures), facet = TRUE) + 
  ggtitle("Heatmap for Progression using PLAGE")
```

## Summary boxplot 
```{r}
method3 <- rbind(data.frame(do.call(rbind,progress_EN), Method="ElasticNet"),
                 data.frame(do.call(rbind,progress_rf), Method="RF"),
                 data.frame(do.call(rbind,progress_svm), Method="SVM"),
                 data.frame(do.call(rbind,progress_mom), Method="Mas-o-menos"),
                 ssgsea_progress_combine,plage_progress_combine)

ggplot(method3, aes(x=.data$Signature, y=.data$AUC, fill=Method)) + 
  geom_boxplot() + theme_bw()
```

