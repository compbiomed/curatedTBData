---
title: "Untitled"
author: "Xutao Wang"
date: "6/30/2020"
output:
  BiocStyle::html_document:
    code_folding: "hide"
    toc_float: true
  BiocStyle::pdf_document: default
package: BiocStyle
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE}
library(BiocParallel)
library(dplyr)
library(DESeq2)
library(edgeR)
library(GEOquery)
library(MultiAssayExperiment)
library(SummarizedExperiment)
library(caret)

devtools::load_all()
library(curatedTBData)
```

# Load and clean data
```{r}
gse_progress <- c("GSE79362", "GSE107994","GSE94438","GSE112104")
progress_raw <- get_curatedTBData(gse_progress)

MaxFilter <- function(df, max.value = 10){
  df.filtered <- df[which(apply(df,1,max) >= max.value),]
  return(df.filtered)
}

# IQR filter
# Get IQR quantile(x, 3/4) - quantile(x, 1/4) for each gene
IQR_Filter <- function(df, top.n.or.ratio, use.ratio = FALSE){
  gene.vec.sorted <- rownames(df)[order(-apply(as.matrix(df), 1, IQR))]
  if (use.ratio == TRUE){
    top.n.or.ratio <- round(top.n.or.ratio * nrow(df))
    df.output <- df[which(rownames(df) %in% gene.vec.sorted[1:top.n.or.ratio]),]
  } else{
    df.output <- df[which(rownames(df) %in% gene.vec.sorted[1:top.n.or.ratio]),]
  }
  return(df.output)
}

## Data cleaning for Africa data
counts.africa.baseline <- progress_raw$GSE79362[["assay_reprocess"]]
# Max 5 filter.
counts.africa.baseline.filtered <- MaxFilter(counts.africa.baseline, 5)
counts.africa.baseline.norm <- DESeq2::vst(counts.africa.baseline.filtered)
# IQR filter
counts.africa.baseline.IQR <- IQR_Filter(counts.africa.baseline.norm, 0.9, use.ratio = TRUE)

GSE79362_train_full <- SummarizedExperiment(list(counts=counts.africa.baseline.IQR),
                                            colData = colData(progress_raw$GSE79362))

# Select samples at baseline
sample_baseline <- colData(GSE79362_train_full)[-nrow(GSE79362_train_full),c("PatientID","MeasurementDay")] %>% 
  data.frame() %>% mutate(sample_name=row.names(colData(GSE79362_train_full))) %>% 
  dplyr::group_by(PatientID) %>%
    dplyr::mutate(first = dplyr::first(sample_name))

# 40 progressor and 105 non-progressor
GSE79362_train_sub <- GSE79362_train_full[,unique(sample_baseline$first)]

# Data Cleaning for Brazil
counts.brazil.baseline <- progress_raw$GSE112104[["assay_reprocess"]]
# Max 5 filter
counts.brazil.baseline.filtered <- MaxFilter(counts.brazil.baseline, 5)
# Normalization
counts.brazil.baseline.norm <- DESeq2::vst(counts.brazil.baseline.filtered)

# IQR filter
counts.brazil.baseline.IQR <- IQR_Filter(counts.brazil.baseline.norm, 0.9, use.ratio = TRUE)

GSE112104_test_full <- SummarizedExperiment(list(counts=counts.brazil.baseline.IQR),
                                            colData = colData(progress_raw$GSE112104))
# Select samples with progression information: 21 progressor 16 non-progressor
GSE112104_test_sub <- GSE112104_test_full[,GSE112104_test_full$TBStatus != "PTB"]

```

# Batch correction
```{r}

```

